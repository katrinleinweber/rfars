---
title: "Rural_roads"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Rural_roads}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(rfars)
library(dplyr)
library(ggplot2)
library(magrittr)
```

This vignette demonstrates how to use the rfars package to download FARS data
and use it to compare crash characteristics and trends in rural and urban areas.
First we download the data, then make a convenient adjustment to the given
coding scheme. Rural and urban crashes and fatalities are then compared on many
different dimensions.

## Data

First we download the data. Calling get_fars(proceed=TRUE) will download data from
2015 to 2020 for all states, and store a 'FARS data' folder in your working
directory, with subfolders for raw and prepared files. When proceed=FALSE, (the 
default) R will ask your permission before downloading files.

```{r}
get_fars(proceed=TRUE)
```

Once you have the data on your hard drive, you don't need to download it again.
Calling use_fars() looks in the working directory for the prepared FARS files,
stacks them, and brings them into the current environment.

```{r}
myFARS <- use_fars()
```

Here we make an adjustment to the standard variable definitions: label all 
people driving motorcycles as Motorcyclists rather than drivers of motorcycles. 
This makes it easier to refer to motorcyclists later. Note that the myFARS 
object is a list, with the flat dataframe containing the required variables: 
body_typ (vehicle body type) and per_typ (person type).

```{r}
myFARS$flat$per_typ <- 
  ifelse(grepl("motorcycle", 
               myFARS$flat$body_typ, 
               ignore.case = TRUE),
         "Motorcyclist",
         myFARS$flat$per_typ)
```

The counts() function makes it easy to generate specific types of counts. Here
we create a function to run two counts, differentiated by urbanicity, and then 
stack the counts for easy graphing.

```{r}
compare_counts <- function(myFARS, what, involved=NULL){
  
  bind_rows(
    counts(myFARS, what=what, involved=involved, where="rural") %>%
      mutate(where = "Rural"),
    counts(myFARS, what=what, involved=involved, where="urban") %>%
      mutate(where = "Urban")
    ) %>%
  return()
  
}
```


## Basic Counts

The number of crashes is a reasonable starting point. Below we use our
compare_counts() function and ggplot() to plot the annual count of crashes
in rural and urban areas, from 2015 to 2020.

```{r}
compare_counts(myFARS, "crashes") %>%

ggplot(aes(x=date, y=n, label=scales::comma(n))) + 
  geom_col() + 
  geom_label(vjust=1) +
  facet_wrap(.~where) +
  labs(x=NULL, y=NULL, title = "Crashes", fill=NULL)
```

```{r}
compare_counts(myFARS, "fatalities") %>%
  
ggplot(aes(x=date, y=n, label=scales::comma(n))) + 
  geom_col() + 
  geom_label(vjust=1) +
  facet_wrap(.~where) +
  labs(x=NULL, y=NULL, title = "Fatalities", fill=NULL)
```

## The filterOnly Option

The counts() function has a filterOnly option, which returns a pre-aggregated 
data frame fitting the other specifications (what, where, etc.). This can be 
useful when generating custom counts. For example, acc_type (Crash Type) is
a vehicle-level variable. To count the number of crashes by acc_type, we need 
to prevent over-counting (as there will be one value for acc_type for each
vehicle involved in each crash). Below we take the value associated with 
veh_no 1 (vehicle number 1). This is reasonable, but may not be appropriate 
for all analysis situations.

```{r}
bind_rows(
  counts(myFARS,
       what = "crashes",
       where = "rural",
       filterOnly = TRUE
       ) %>%
    filter(veh_no==1) %>% #crash type is on the vehicle-level, this prevents over-counting
    select(id, year, acc_type) %>% unique() %>% group_by(acc_type, year) %>% summarize(n=n()) %>%
    mutate(where = "Rural"),
  counts(myFARS,
       what = "crashes",
       where = "urban",
       filterOnly = TRUE
       ) %>%
    filter(veh_no==1) %>%
    select(id, year, acc_type) %>% unique() %>% group_by(acc_type, year) %>% summarize(n=n()) %>%
    mutate(where = "Urban")
    ) %>%
  filter(!is.na(acc_type)) %>%
  group_by(where, acc_type) %>% summarize(n=sum(n, na.rm=TRUE)) %>%
  tidyr::pivot_wider(names_from = "where", values_from = "n") %>%
  mutate(Total = Urban + Rural,
         rural_pct = Rural/Total) %>%
  arrange(desc(Total)) %>%
  slice(1:20) %>%
  arrange(desc(rural_pct)) %>%
  mutate(acc_type = reorder(acc_type, rural_pct)) %>%
  
  ggplot(aes(y=acc_type, x=rural_pct, fill=Rural, label=scales::percent(rural_pct, accuracy = 1))) + 
    geom_col() + 
    geom_label(hjust=1, fill="white") +
  scale_fill_continuous(labels=scales::comma) +
    labs(x=NULL, y=NULL, 
         title = "20 Most Common Crash Types by Prevalence in Rural Areas") +
    theme(plot.title.position = "plot")
```


## The flat Data Frame

It may be easiest to access the data directly, rather than via the counts()
function. The object created by use_fars() is a list with up to four elements:
flat, multi_acc, multi_veh, and multi_per. The flat data frame contains over
200 variables, and can often provide what's needed. Below we aggregate crash
counts by road curvature by urbanicity. 

```{r}
# myFARS$flat %$% table(valign, year)
# myFARS$flat %$% table(vprofile, year)
# myFARS$flat %$% table(vprofile, valign)

myFARS$flat %>%
  mutate(valign = ifelse(grepl("Curve", valign), "Curve", valign)) %>%
  filter(veh_no == 1, #to avoid over-counting
         rur_urb %in% c("Rural", "Urban"),
         valign %in% c("Straight", "Curve")) %>%
  select(id, valign, rur_urb) %>% unique() %>%
  group_by(valign, rur_urb) %>%
  summarize(n = n()) %>%
  
  ggplot(aes(fill=rur_urb, y=n, x=valign, label=scales::comma(n, accuracy = 1))) + 
    geom_col(position = "dodge") + 
    geom_label(vjust=1, position = position_dodge(.9))
```


```{r}
myFARS$flat %>%
  mutate(vprofile = ifelse(vprofile %in% c("Uphill", "Downhill"), "Up/downhill", vprofile)) %>%
  filter(veh_no == 1, #to avoid over-counting
         rur_urb %in% c("Rural", "Urban"),
         !(vprofile %in% c("Unknown", "Reported as Unknown", "Not Reported"))
         ) %>%
  select(id, vprofile, rur_urb) %>% unique() %>%
  group_by(vprofile, rur_urb) %>%
  summarize(n = n()) %>%
  
  ggplot(aes(fill=rur_urb, x=n, y=vprofile, label=scales::comma(n, accuracy = 1))) + 
    geom_col(position = "dodge") + 
    geom_label(hjust=1, position = position_dodge(.9))
```

```{r}
myFARS$flat %>%
  mutate(
    vprofile = ifelse(vprofile %in% c("Uphill", "Downhill"), "Up/downhill", vprofile),
    valign = ifelse(grepl("Curve", valign), "Curve", valign)
    ) %>%
  filter(veh_no == 1, #to avoid over-counting
         rur_urb %in% c("Rural", "Urban"),
         valign %in% c("Straight", "Curve"),
         !(vprofile %in% c("Unknown", "Reported as Unknown", "Not Reported"))
         ) %>%
  select(id, vprofile, valign, rur_urb) %>% unique() %>%
  group_by(vprofile, valign, rur_urb) %>%
  summarize(n = n()) %>%
  
ggplot(aes(x=valign, y=vprofile, fill=n, label=scales::comma(n))) +
  geom_tile() +
  facet_wrap(.~rur_urb) +
  viridis::scale_fill_viridis() +
  geom_label()

```


### by Person Type

```{r}
myFARS$flat %>%
  filter(rur_urb %in% c("Rural", "Urban")) %>%
  filter(grepl("(K)", inj_sev)) %>%
  group_by(rur_urb, per_typ) %>%
  summarise(n=n()) %>%
  filter(n>900) %>%
  mutate(per_typ = stringr::str_wrap(per_typ, 15)) %>%
  
  ggplot(aes(x=per_typ, y=n, fill=rur_urb, label = scales::comma(n))) +
    geom_col(vjust=1, position = "dodge") +
    geom_label(position = position_dodge(.9))
```

### by Sex

```{r}
myFARS$flat %>%
  filter(rur_urb %in% c("Rural", "Urban")) %>%
  filter(grepl("(K)", inj_sev)) %>%
  group_by(rur_urb, sex) %>%
  summarise(n=n()) %>%
  filter(n>900) %>%
  mutate(sex = stringr::str_wrap(sex, 15)) %>%
  
  ggplot(aes(x=sex, y=n, fill=rur_urb, label = scales::comma(n))) +
    geom_col(position = "dodge") +
    geom_label(vjust=1, position = position_dodge(.9))
```


### by Ethnicity

```{r}
myFARS$flat %>%
  filter(rur_urb %in% c("Rural", "Urban")) %>%
  filter(grepl("(K)", inj_sev)) %>%
  group_by(rur_urb, hispanic) %>%
  summarise(n=n()) %>%
  filter(n>900) %>%
  mutate(hispanic = stringr::str_wrap(hispanic, 15)) %>%
  
  ggplot(aes(x=hispanic, y=n, fill=rur_urb, label = scales::comma(n))) +
    geom_col(position = "dodge") +
    geom_label(vjust=1, position = position_dodge(.9))
```

### by Vehicle Type

(Excludes pedbikes)

```{r}
myFARS$flat %>%
  filter(rur_urb %in% c("Rural", "Urban")) %>%
  filter(grepl("(K)", inj_sev)) %>%
  filter(!(per_typ %in% c("Bicyclist", "Pedestrian"))) %>%
  group_by(rur_urb, body_typ) %>%
  summarise(n=n()) %>%
  filter(n>3000) %>%
  mutate(body_typ = stringr::str_wrap(body_typ, 80)) %>%

  ggplot(aes(y=body_typ, x=n, fill=rur_urb, label=scales::comma(n, accuracy = 1))) + 
    geom_col(position = "dodge") + 
    geom_label(hjust=1, position = position_dodge(.9))
```


### Motorcyclists and Helmet Use

```{r}
#myFARS$flat %$% table(helm_use, year)
#myFARS$flat %$% table(rest_use, year)

myFARS$flat %>%
  filter(grepl("(K)", inj_sev), 
         per_typ == "Motorcyclist",
         rur_urb %in% c("Rural", "Urban")) %>%
  mutate(motorcyclist_helmet = case_when(
    rest_use %in% c("No Helmet") ~ "No Helmet",
    rest_use %in% c("DOT-Compliant Motorcycle Helmet",
                    "Helmet, Other than DOT-Compliant Motorcycle Helmet",
                    "Helmet, Unknown if DOT Compliant") ~ "Helmet Worn",
    helm_use %in% c("No Helmet") ~ "No Helmet",
    helm_use %in% c("DOT-Compliant Motorcycle Helmet",
                    "Helmet, Other than DOT-Compliant Motorcycle Helmet",
                    "Helmet, Unknown if DOT Compliant") ~ "Helmet Worn",
    TRUE ~ "Other")
    ) %>%
  group_by(rur_urb, motorcyclist_helmet) %>%
  summarize(n = n()) %>%
  
  ggplot(aes(fill=motorcyclist_helmet, y=n, x=rur_urb, label=scales::comma(n, accuracy = 1))) + 
    geom_col(position = "dodge") + 
    geom_label(vjust=1, position = position_dodge(.9)) +
    labs(title = "Motorcyclists and Helmet Use")
```

### by Victim Age

```{r}
myFARS$flat %>%
  filter(grepl("(K)", inj_sev), 
         rur_urb %in% c("Rural", "Urban")) %>%
  mutate(age_n = gsub("\\D+","", age) %>% as.numeric()) %>%
  group_by(rur_urb, age_n) %>% summarize(n=n()) %>%
  
  ggplot(aes(x=age_n, y=n, color = rur_urb)) +
    geom_line()
```


### by Age and Time

```{r}
myFARS$flat %>%
  mutate(age_n = gsub("\\D+","", age) %>% as.numeric()) %>%
  filter(grepl("(K)", inj_sev),
         rur_urb %in% c("Rural", "Urban"),
         hour < 25,
         age_n <= 90) %>%
  group_by(rur_urb, age_n, hour) %>% summarize(n=n()) %>%
  
  ggplot(aes(x=hour, y=age_n, fill=n)) +
    geom_tile() +
    facet_wrap(.~rur_urb) +
    viridis::scale_fill_viridis()
```


## The multi_per Data Frame

```{r}
myFARS$multi_per %>% 
  filter(name == "race") %>%
  select(state, st_case, veh_no, per_no, year, race=value) %>%
  inner_join(myFARS$flat) %>%
  
  filter(rur_urb %in% c("Rural", "Urban")) %>%
  filter(grepl("(K)", inj_sev)) %>%
  group_by(rur_urb, race) %>%
  summarise(n=n()) %>%
  filter(n>900) %>%
  mutate(race = stringr::str_wrap(race, 15)) %>%
  
  ggplot(aes(x=race, y=n, fill=rur_urb, label = scales::comma(n))) +
    geom_col(position = "dodge") +
    geom_label(vjust=1, position = position_dodge(.9))
```


## The involved Option

counts() makes it easy to hone in on specific crash types by using the involved
argument. It can be any of distracted driver, drowsy driver, police pursuit, 
motorcycle, pedalcyclist, bicyclist, pedestrian, pedbike, young driver, 
older driver, speeding, alcohol, drugs, hit and run, roadway departure, 
rollover, or large trucks.

Below we use our compare_counts() function to specify 

```{r}
crashfactors <- c("distracted driver", "drowsy driver", "police pursuit", 
                  "motorcycle", "pedalcyclist", "bicyclist", "pedestrian", 
                  "pedbike", "young driver", "older driver", "speeding", 
                  "alcohol", "drugs", "hit and run", "roadway departure", "rollover", 
                  "large trucks"
                  )

for(crashfactor in crashfactors){
  
  p <- 
    compare_counts(myFARS, "fatalities", involved = crashfactor) %>%
    ggplot(aes(x=year, y=n, label=scales::comma(n))) +
      geom_col(position="dodge") +
      facet_wrap(.~where) +
      geom_label(position = position_dodge(.9), vjust=1) +
      labs(title = paste0("Fatalities: ", crashfactor))

  print(p)
  
}
```





