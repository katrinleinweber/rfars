---
output: github_document
editor_options: 
  markdown: 
    wrap: 80
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%", 
  dpi = 500
)
```

# rfars

<!-- badges: start -->

<!-- badges: end -->

The goal of `rfars` is to simplify the process of analyzing FARS data. FARS
stands for [Fatality Analysis Reporting
System](https://www.nhtsa.gov/research-data/fatality-analysis-reporting-system-fars),
the census of fatal crashes in the United States maintained by the [National
Highway Traffic Safety Administration](https://www.nhtsa.gov/). The [Fatality
and Injury Reporting System Tool](https://cdan.dot.gov/query) allows users to
generate queries, and can produce simple tables and graphs. This suffices for
simple analysis, but often leaves researchers wanting more. Digging any deeper,
however, involves a time-consuming process of downloading annual ZIP files and
attempting to stitch them together - after first combing through the immense
[data
dictionary](https://crashstats.nhtsa.dot.gov/Api/Public/ViewPublication/813254)
to determine the required variables and table names. `rfars` allows users to
download FARS data back to 2016 with just two lines of code. The result is a
full, rich dataset ready for mapping, modeling, and other downstream analysis.
Helper functions are also provided to produce common counts and comparisons.

A companion package `rfarsplus` (currently in development) will provide exposure
data and facilitate the calculation of various rates.

## Installation

You can install the latest version of `rfars` from [GitHub](https://github.com/)
with:

``` r
# install.packages("devtools")
devtools::install_github("s87jackson/rfars")
```

Then load the required packages:

```{r}
library(rfars)
library(dplyr)
library(ggplot2)
library(leaflet)
library(leaflet.extras)
```

## Getting and Using FARS Data

Use the `get_fars()` function to download the ZIP files from NHTSA and save the
prepared files to your hard drive. This only has to be run once and defaults to
saving everything in the current working directory. Below we import all
available data for the state of Virginia. Note that `get_fars()` requires your
permission to download the ZIP files and store prepared CSVs locally, unless you
set `proceed=TRUE`.

```{r}
get_fars(states="VA", proceed=TRUE)
```

The `use_fars()` function looks in a specified directory (the working directory
by default) for certain CSV files and compiles them into a list with five
tibbles: `flat`, `multi_acc`, `multi_veh`, `multi_per`, and `events`.

```{r}
myFARS <- use_fars() 
```

The `flat` tibble contains all variables for which there is just one value per
person, vehicle, or crash (e.g., age, travel speed, lighting). Each row
corresponds to a person involved in a crash. As there may be multiple people
and/or vehicles involved in one crash, some variable-values are repeated within
a crash or vehicle. Each crash is uniquely identified with `id`, which is a
combination of `year` and `st_case`. Note that `st_case` is not unique across
years, for example, `st_case` 510001 will appear in each year. The `id` variable
attempts to avoid this issue.

The `multi_` tibbles contain those variables for which there may be a varying
number of values for any entity (e.g., driver impairments, vehicle events,
weather conditions at time of crash). Each tibble has the requisite data
elements corresponding to the entity: `multi_acc` includes `st_case` and `year`,
`multi_veh` adds `veh_no` (vehicle number), and `multi_per` adds `per_no`
(person number).

The `events` tibble provides a sequence of numbered events for each vehicle in
each crash.

```{r}
str(myFARS)
```

You can review the list of variables to help guide your analysis with:

``` r
View(fars_varnames)
```

## Counts

A first step in many transportation safety analyses involves counting the number
of relevant crashes, fatalities, or people involved. `counts()` lets users
specify *what* to count, *where* to count them (rural/urban and/or in specified
states), *who* to include, which *years* to include and an aggregation
*interval* (annually or monthly), and factors *involved* in the crash. It
returns a simple tibble that can be easily piped into `ggplot()` to quickly
visualize counts.

```{r, fig.height=2.2}
counts(
  myFARS,
  what = "crashes",
  interval = c("year")
  ) %>%
  ggplot(aes(x=date, y=n, label=scales::comma(n))) + 
    geom_col() + 
    geom_label(vjust=1.2) +
    labs(x=NULL, y=NULL, title = "Fatal Crashes in Virginia")
```

```{r, fig.height=2.2}
counts(
  myFARS,
  what = "fatalities",
  interval = c("year")
  ) %>%
  ggplot(aes(x=date, y=n, label=scales::comma(n))) + 
    geom_col() + 
    geom_label(vjust=1.2) +
    labs(x=NULL, y=NULL, title = "Fatalities in Virginia")
```

```{r, fig.height=2.2}
counts(myFARS,
       what = "fatalities",
       where = "rural",
       interval = c("year")
       ) %>%
  ggplot(aes(x=date, y=n, label=scales::comma(n))) + 
    geom_col() + 
    geom_label(vjust=1.2) +
    labs(x=NULL, y=NULL, title = "Rural Fatalities in Virginia")
```

```{r, fig.height=2.2}
counts(myFARS,
       what = "fatalities",
       where = "rural",
       interval = c("year"),
       involved = "speeding"
       ) %>%
  ggplot(aes(x=date, y=n, label=scales::comma(n))) + 
    geom_col() + 
    geom_label(vjust=1.2) +
    labs(x=NULL, y=NULL, title = "Speeding-Related Fatalities\nin Rural Virginia")
```

We can combine two `counts()` results to make a comparison. Here we compare the
number of speeding-related fatalities in rural and urban Virginia:

```{r, fig.height=2.4}
bind_rows(
  counts(myFARS,
       what = "fatalities",
       where = "rural",
       interval = c("year"),
       involved = "speeding"
       ) %>%
    mutate(where = "Rural"),
  counts(myFARS,
       what = "fatalities",
       where = "urban",
       interval = c("year"),
       involved = "speeding"
       ) %>%
    mutate(where = "Urban")
    ) %>%
  ggplot(aes(x=date, y=n, label=scales::comma(n))) + 
    geom_col() + 
    geom_label(vjust=1.2) +
    facet_wrap(.~where) +
    labs(x=NULL, y=NULL, title = "Speeding-Related Fatalities in Virginia", fill=NULL)
```

## Mapping

We can take advantage of having access to the full data with maps. Here we map
pedestrian and bicyclist fatalities in Virginia:

```{r}
counts(
  myFARS, 
  what = "crashes", 
  involved = "pedbike", 
  filterOnly = TRUE
  ) %>%
leaflet() %>%
  addTiles() %>%
  addHeatmap(group = "Heatmap", radius=10, blur=20, minOpacity = .01, max = .2, cellSize = 1) %>%
  addCircleMarkers(
    radius = 1,
    color = "red",
    stroke = FALSE,
    fillOpacity = 0.7, group = "Crash Locations") 
```

Drug-related crashes:

```{r}
counts(
  myFARS, 
  what = "crashes", 
  involved = "drugs", 
  filterOnly = TRUE
  ) %>%
  filter(!is.na(lat), !is.na(lon)) %>%
leaflet() %>%
  addTiles() %>%
  addHeatmap(group = "Heatmap", radius=10, blur=20, minOpacity = .01, max = .2, cellSize = 1) %>%
  addCircleMarkers(
    radius = 1,
    color = "red",
    stroke = FALSE,
    fillOpacity = 0.7, group = "Crash Locations") 
```

Young drivers:

```{r}
counts(
  myFARS, 
  what = "crashes", 
  involved = "young driver", 
  filterOnly = TRUE
  ) %>%
  filter(!is.na(lat), !is.na(lon)) %>%
leaflet() %>%
  addTiles() %>%
  addHeatmap(group = "Heatmap", radius=10, blur=20, minOpacity = .01, max = .2, cellSize = 1) %>%
  addCircleMarkers(
    radius = 1,
    color = "red",
    stroke = FALSE,
    fillOpacity = 0.7, group = "Crash Locations") 
```

## Modeling

Having access to the full dataset also allows us to develop statistical models.
Here we fit a simple model of injury severity as a function of age and restraint
use. It tells us that the average severity score among motor vehicle drivers and
occupants wearing seatbelts (both the lap and shoulder belts) is 1.7 (close to,
but less than "Suspected Minor Injury (B)"). Partial seatbelt use increases the
predicted score to 2.1 (slightly above "Suspected Minor Injury (B)"). Not
wearing any seatbelt, however increases the predicted score to 3.2 (slightly
above "Suspected Serious Injury (A)").

```{r}
# table(myFARS$flat$inj_sev)
# table(myFARS$flat$rest_use, useNA = "ifany")
# table(myFARS$flat$per_typ, useNA = "ifany")

myFARS$flat %>%
  filter(rest_use %in% c("Lap Belt Only Used",
                         "Shoulder Belt Only Used",
                         "None Used / Not Applicable",
                         "None Used/Not Applicable",
                         "Shoulder and Lap Belt Used"),
         per_typ %in% c("Driver of a Motor Vehicle In-Transport",
                        "Passenger of a Motor Vehicle In-Transport")
         ) %>%
  mutate(
    rest_use = case_when(
      rest_use %in% c("Lap Belt Only Used", "Shoulder Belt Only Used") ~ "Partial",
      rest_use %in% c("None Used / Not Applicable", "None Used/Not Applicable") ~ "None",
      rest_use %in% c("Shoulder and Lap Belt Used") ~ "Full",
      TRUE ~ "Unknown"
      ) %>%
      as.factor() %>%
      relevel(ref = "Full"),
    kabco = case_when(
      inj_sev == "Fatal Injury (K)" ~ 4,
      inj_sev %in% c("Suspected Serious Injury (A)", 
                     "Suspected Serious Injury(A)") ~ 3,
      inj_sev %in% c("Suspected Minor Injury (B)", 
                     "Suspected Minor Injury(B)") ~ 2,
      inj_sev == "Possible Injury (C)" ~ 1,
      inj_sev == "No Apparent Injury (O)" ~ 0,
      TRUE ~ as.numeric(NA)
      ),
    age_n = gsub("\\D+","", age) %>% as.numeric()) %>%
  lm(kabco ~ age_n + rest_use, data = .) %>%
  summary()
```
